<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for pool\AimStaking.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">pool/</a> AimStaking.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>65/65</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">95.95% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>71/74</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>15/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>82/82</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">219×</span>
<span class="cline-any cline-yes">219×</span>
<span class="cline-any cline-yes">219×</span>
<span class="cline-any cline-yes">219×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">55×</span>
<span class="cline-any cline-yes">54×</span>
<span class="cline-any cline-yes">53×</span>
<span class="cline-any cline-yes">53×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">64×</span>
<span class="cline-any cline-yes">63×</span>
<span class="cline-any cline-yes">63×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">62×</span>
<span class="cline-any cline-yes">61×</span>
<span class="cline-any cline-yes">59×</span>
<span class="cline-any cline-yes">59×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">107×</span>
<span class="cline-any cline-yes">104×</span>
<span class="cline-any cline-yes">101×</span>
<span class="cline-any cline-yes">98×</span>
<span class="cline-any cline-yes">98×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">96×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">96×</span>
<span class="cline-any cline-yes">96×</span>
<span class="cline-any cline-yes">96×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">96×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">96×</span>
<span class="cline-any cline-yes">96×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">96×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">64×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">64×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.21;
&nbsp;
import "@openzeppelin/contracts-upgradeable/access/extensions/AccessControlEnumerableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/utils/ReentrancyGuardUpgradeable.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
&nbsp;
/**
 * @title AimStaking
 * @dev A contract for staking ERC20 tokens for different projects with various lock-up durations.
 * It allows project managers to define staking parameters and collect fees.
 * This contract is upgradeable.
 */
contract AimStaking is AccessControlEnumerableUpgradeable, ReentrancyGuardUpgradeable {
    /**
     * @dev Role identifier for managers who can configure staking parameters.
     */
    bytes32 public constant MANAGER_ROLE = keccak256("MANAGER_ROLE");
&nbsp;
    /**
     * @dev The wallet address where collected fees are sent.
     */
    address public feeWallet;
    /**
     * @dev The fee rate for regular unstaking, in basis points (1/10000). E.g., 100 means 1%.
     */
    uint256 public unstakeFeeRate; // in basis points, e.g., 100 = 1%
    /**
     * @dev The fee rate for emergency unstaking, in basis points. E.g., 500 means 5%.
     */
    uint256 public emergencyUnstakeFeeRate; // in basis points, e.g., 100 = 1%
&nbsp;
    /**
     * @dev Mapping from a project ID to its designated staking token address.
     */
    mapping(bytes32 =&gt; address) public projectStakingTokens;
&nbsp;
    /**
     * @dev The possible statuses of a stake.
     */
    enum StakeStatus { Active, Unstaked, EmergencyUnstaked }
&nbsp;
    /**
     * @dev Represents a single stake instance.
     */
    struct Stake {
        uint256 stakeId;      // Unique identifier for the stake.
        address user;         // The address of the staker.
        uint256 amount;       // The amount of tokens staked.
        bytes32 projectId;    // The project for which the tokens are staked.
        address stakingToken; // The address of the staked ERC20 token.
        uint256 stakedAt;     // Timestamp of when the stake was created.
        uint256 duration;     // The lock-up duration in seconds.
        uint256 unlockedAt;   // Timestamp when the stake becomes unlockable.
        StakeStatus status;   // The current status of the stake.
    }
&nbsp;
    /**
     * @dev Mapping from a stake ID to the Stake struct.
     */
    mapping(uint256 =&gt; Stake) public stakes;
    /**
     * @dev Mapping from a user's address to an array of their stake IDs.
     */
    mapping(address =&gt; uint256[]) private userStakes;
    /**
     * @dev Mapping from a project ID to an array of its associated stake IDs.
     */
    mapping(bytes32 =&gt; uint256[]) private projectStakes;
    /**
     * @dev Mapping to track registered projects. Only registered projects can be staked into.
     */
    mapping(bytes32 =&gt; bool) public registeredProjects;
    /**
     * @dev Mapping to store valid staking duration options in days.
     */
    mapping(uint256 =&gt; bool) public durationOptions; // duration in days
&nbsp;
    /**
     * @dev A counter to generate unique stake IDs.
     */
    uint256 private _stakeCounter;
&nbsp;
    event ProjectRegistered(bytes32 projectId);
    event ProjectUnregistered(bytes32 projectId);
    event DurationOptionAdded(uint256 duration);
    event DurationOptionRemoved(uint256 duration);
    event Staked(
        uint256 stakeId,
        address indexed user,
        uint256 amount,
        bytes32 indexed projectId,
        uint256 duration
    );
    event Unstaked(uint256 stakeId, address indexed user, uint256 amount);
    event EmergencyUnstaked(uint256 stakeId, address indexed user, uint256 amount);
    event ProjectStakingTokenSet(bytes32 indexed projectId, address tokenAddress);
&nbsp;
    event FeeWalletSet(address indexed newWallet);
    event UnstakeFeeRateSet(uint256 newRate);
    event EmergencyUnstakeFeeRateSet(uint256 newRate);
&nbsp;
    /**
     * @dev Initializes the contract, setting the admin role.
     * @param admin The address to be granted the default admin and manager roles.
     */
    function initialize(address admin) external initializer {
        __ReentrancyGuard_init();
        _grantRole(DEFAULT_ADMIN_ROLE, admin);
        _grantRole(MANAGER_ROLE, admin);
        feeWallet = admin;
    }
&nbsp;
    /**
     * @dev Sets the wallet address for collecting fees.
     * Can only be called by an address with the MANAGER_ROLE.
     * @param _feeWallet The new fee wallet address.
     */
    function setFeeWallet(address _feeWallet) external onlyRole(MANAGER_ROLE) {
        require(_feeWallet != address(0), "Invalid fee wallet address");
        feeWallet = _feeWallet;
        emit FeeWalletSet(_feeWallet);
    }
&nbsp;
    /**
     * @dev Sets the fee rate for regular unstaking.
     * Can only be called by an address with the MANAGER_ROLE.
     * @param _unstakeFeeRate The new unstake fee rate in basis points.
     */
    function setUnstakeFeeRate(uint256 _unstakeFeeRate) external onlyRole(MANAGER_ROLE) {
        require(_unstakeFeeRate &lt;= 10000, "Fee rate cannot exceed 100%");
        unstakeFeeRate = _unstakeFeeRate;
        emit UnstakeFeeRateSet(_unstakeFeeRate);
    }
&nbsp;
    /**
     * @dev Sets the fee rate for emergency unstaking.
     * Can only be called by an address with the MANAGER_ROLE.
     * @param _emergencyUnstakeFeeRate The new emergency unstake fee rate in basis points.
     */
    function setEmergencyUnstakeFeeRate(uint256 _emergencyUnstakeFeeRate) external onlyRole(MANAGER_ROLE) {
        require(_emergencyUnstakeFeeRate &lt;= 10000, "Fee rate cannot exceed 100%");
        emergencyUnstakeFeeRate = _emergencyUnstakeFeeRate;
        emit EmergencyUnstakeFeeRateSet(_emergencyUnstakeFeeRate);
    }
&nbsp;
    /**
     * @dev Sets the staking token for a specific project.
     * Can only be called by an address with the MANAGER_ROLE.
     * @param projectId The ID of the project.
     * @param stakingTokenAddress The address of the ERC20 token for staking.
     */
    function setProjectStakingToken(bytes32 projectId, address stakingTokenAddress) external onlyRole(MANAGER_ROLE) {
        require(registeredProjects[projectId], "Project not registered");
        require(stakingTokenAddress != address(0), "AimStaking: Invalid staking token address");
        projectStakingTokens[projectId] = stakingTokenAddress;
        emit ProjectStakingTokenSet(projectId, stakingTokenAddress);
    }
&nbsp;
    /**
     * @dev Registers a new project.
     * Can only be called by an address with the MANAGER_ROLE.
     * @param projectId The ID of the project to register.
     */
    function registerProject(bytes32 projectId) external onlyRole(MANAGER_ROLE) {
        require(!registeredProjects[projectId], "Project already registered");
        registeredProjects[projectId] = true;
        emit ProjectRegistered(projectId);
    }
&nbsp;
    /**
     * @dev Unregisters an existing project.
     * Can only be called by an address with the MANAGER_ROLE.
     * @param projectId The ID of the project to unregister.
     */
    function unregisterProject(bytes32 projectId) external onlyRole(MANAGER_ROLE) {
        require(registeredProjects[projectId], "Project not registered");
        registeredProjects[projectId] = false;
        emit ProjectUnregistered(projectId);
    }
&nbsp;
    /**
     * @dev Adds a new valid staking duration option.
     * Can only be called by an address with the MANAGER_ROLE.
     * @param durationInDays The new duration in days.
     */
    function addDurationOption(uint256 durationInDays) external onlyRole(MANAGER_ROLE) {
        require(durationInDays &gt; 0, "Duration must be positive");
        require(!durationOptions[durationInDays], "Duration option already exists");
        durationOptions[durationInDays] = true;
        emit DurationOptionAdded(durationInDays);
    }
&nbsp;
    /**
     * @dev Removes an existing staking duration option.
     * Can only be called by an address with the MANAGER_ROLE.
     * @param durationInDays The duration in days to remove.
     */
    function removeDurationOption(uint256 durationInDays) external onlyRole(MANAGER_ROLE) {
        require(durationOptions[durationInDays], "Duration option not found");
        durationOptions[durationInDays] = false;
        emit DurationOptionRemoved(durationInDays);
    }
&nbsp;
    /**
     * @dev Stakes a specified amount of tokens for a given project and duration.
     * @param amount The amount of tokens to stake.
     * @param durationInDays The staking duration in days.
     * @param projectId The ID of the project to stake for.
     */
    function stake(uint256 amount, uint256 durationInDays, bytes32 projectId) external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        require(amount &gt; 0, "Amount must be &gt; 0");
        require(durationOptions[durationInDays], "Invalid duration");
        require(registeredProjects[projectId], "Project not registered");
        address stakingTokenAddress = projectStakingTokens[projectId];
        require(stakingTokenAddress != address(0), "Staking token not set for project");
&nbsp;
        // Transfer tokens from the user to this contract
        IERC20(stakingTokenAddress).transferFrom(msg.sender, address(this), amount);
&nbsp;
        // Create and store the new stake
        uint256 stakeId = ++_stakeCounter;
        uint256 durationInSeconds = durationInDays * 1 days;
        uint256 unlockedAt = block.timestamp + durationInSeconds;
&nbsp;
        stakes[stakeId] = Stake({
            stakeId: stakeId,
            user: msg.sender,
            amount: amount,
            projectId: projectId,
            stakingToken: stakingTokenAddress,
            stakedAt: block.timestamp,
            duration: durationInSeconds,
            unlockedAt: unlockedAt,
            status: StakeStatus.Active
        });
&nbsp;
        // Track the stake for the user and the project
        userStakes[msg.sender].push(stakeId);
        projectStakes[projectId].push(stakeId);
&nbsp;
        emit Staked(stakeId, msg.sender, amount, projectId, durationInSeconds);
    }
&nbsp;
    /**
     * @dev Unstakes tokens after the lock-up period has passed.
     * A fee may be applied.
     * @param stakeId The ID of the stake to unstake.
     */
    function unstake(uint256 stakeId) external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        Stake storage userStake = stakes[stakeId];
        require(userStake.user == msg.sender, "Not stake owner");
        require(userStake.status == StakeStatus.Active, "Stake not active");
        require(block.timestamp &gt;= userStake.unlockedAt, "Stake still locked");
&nbsp;
        userStake.status = StakeStatus.Unstaked;
&nbsp;
        uint256 amountToUnstake = userStake.amount;
        // Apply unstake fee if applicable
        if (unstakeFeeRate &gt; 0 &amp;&amp; feeWallet != address(0)) {
            uint256 fee = (amountToUnstake * unstakeFeeRate) / 10000;
            if (fee &gt; 0) {
                IERC20(userStake.stakingToken).transfer(feeWallet, fee);
            }
            amountToUnstake -= fee;
        }
&nbsp;
        // Transfer the remaining amount back to the user
        IERC20(userStake.stakingToken).transfer(msg.sender, amountToUnstake);
&nbsp;
        emit Unstaked(stakeId, msg.sender, userStake.amount);
    }
&nbsp;
    /**
     * @dev Allows a user to unstake their tokens before the lock-up period ends.
     * A higher fee is applied for this action.
     * @param stakeId The ID of the stake to unstake.
     */
    function emergencyUnstake(uint256 stakeId) external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
        Stake storage userStake = stakes[stakeId];
        require(userStake.user == msg.sender, "Not stake owner");
        require(userStake.status == StakeStatus.Active, "Stake not active");
&nbsp;
        userStake.status = StakeStatus.EmergencyUnstaked;
&nbsp;
        uint256 amountToUnstake = userStake.amount;
        // Apply emergency unstake fee if applicable
        if (emergencyUnstakeFeeRate &gt; 0 &amp;&amp; feeWallet != address(0)) {
            uint256 fee = (amountToUnstake * emergencyUnstakeFeeRate) / 10000;
            if (fee &gt; 0) {
                IERC20(userStake.stakingToken).transfer(feeWallet, fee);
            }
            amountToUnstake -= fee;
        }
&nbsp;
        // Transfer the remaining amount back to the user
        IERC20(userStake.stakingToken).transfer(msg.sender, amountToUnstake);
&nbsp;
        emit EmergencyUnstaked(stakeId, msg.sender, userStake.amount);
    }
&nbsp;
    /**
     * @dev Retrieves all stake IDs for a given user.
     * @param user The address of the user.
     * @return An array of stake IDs.
     */
    function getUserStakes(address user) external view returns (uint256[] memory) {
        return userStakes[user];
    }
    
    /**
     * @dev Retrieves all stake IDs for a given project.
     * @param projectId The ID of the project.
     * @return An array of stake IDs.
     */
    function getProjectStakes(bytes32 projectId) external view returns (uint256[] memory) {
        return projectStakes[projectId];
    }
&nbsp;
    /**
     * @dev Retrieves all active stake IDs for a given user.
     * This function is useful for UIs to display current user stakes.
     * @param user The address of the user.
     * @return An array of active stake IDs.
     */
    function getActiveUserStakes(address user) external view returns (uint256[] memory) {
        uint256[] memory allStakes = userStakes[user];
        uint256 activeCount = 0;
        // First, count the number of active stakes to initialize the array with the correct size.
        for (uint i = 0; i &lt; allStakes.length; i++) {
            if (stakes[allStakes[i]].status == StakeStatus.Active) {
                activeCount++;
            }
        }
&nbsp;
        // Populate the new array with active stake IDs.
        uint256[] memory activeStakes = new uint256[](activeCount);
        uint256 index = 0;
        for (uint i = 0; i &lt; allStakes.length; i++) {
            if (stakes[allStakes[i]].status == StakeStatus.Active) {
                activeStakes[index] = allStakes[i];
                index++;
            }
        }
        return activeStakes;
    }
} </pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Jun 24 2025 15:08:45 GMT+0800 (中国标准时间)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
